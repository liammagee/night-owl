<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline';
        style-src 'self' 'unsafe-inline';
        font-src 'self' data:;
        img-src 'self' data: https: http: blob:;
        media-src 'self' blob: data:;
        connect-src 'self';
        worker-src 'self' blob:;
    ">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NightOwl - Philosophical Writing & Teaching</title>
    <link rel="icon" type="image/png" href="build/icon.png">
    <link rel="icon" type="image/svg+xml" href="build/icon.svg">
    
    <!-- Styles -->
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="orchestrator/style.css">
    <link rel="stylesheet" href="css/base.css">
    <link rel="stylesheet" href="css/theme.css">
    <link rel="stylesheet" href="css/layout.css">
    <link rel="stylesheet" href="css/modes.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/speaker-notes.css">
    <link rel="stylesheet" href="css/preview-presentation.css">
    <link rel="stylesheet" href="css/search.css">
    <link rel="stylesheet" href="css/interactions.css">
    <link rel="stylesheet" href="css/gamification.css">
    <link rel="stylesheet" href="css/latex-style.css">
    
    <!-- Scripts -->
    <script id="marked-script" src="lib/marked.min.js"></script>
    
    <!-- MathJax Configuration -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true,
                tags: 'ams'
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code', 'a'],
                ignoreHtmlClass: 'tex2jax_ignore',
                processHtmlClass: 'tex2jax_process'
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script id="MathJax-script" async src="lib/tex-svg.js"></script>
    
    <script src="lib/react.production.min.js"></script>
    <script src="lib/react-dom.production.min.js"></script>
    <script src="lib/html2canvas.min.js"></script>
    
    <!-- PDF.js for PDF viewing and search -->
    <script type="module">
        import * as pdfjsLib from './lib/pdfjs/pdf.min.js';
        pdfjsLib.GlobalWorkerOptions.workerSrc = './lib/pdfjs/pdf.worker.min.js';
        window.pdfjsLib = pdfjsLib;
    </script>
    <!-- D3.js v7.8.5 (local copy) for visualizations and whole/part diagrams -->
    <script src="lib/d3.min.js"></script>
    <!-- Babel no longer needed - using pre-compiled components -->
    <style>
        /* Tailwind-inspired utility classes for presentation view */
        .w-full { width: 100%; }
        .h-full { height: 100%; }
        .h-screen { height: 100vh; }
        .bg-gray-900 { background-color: #1a1a1a; }
        .bg-gray-800 { background-color: #2d2d2d; }
        .bg-gray-700 { background-color: #404040; }
        .bg-gray-600 { background-color: #525252; }
        .bg-blue-600 { background-color: #16a34a; }
        .bg-blue-700 { background-color: #15803d; }
        .bg-green-600 { background-color: #16a34a; }
        .bg-green-700 { background-color: #15803d; }
        .bg-red-600 { background-color: #dc2626; }
        .bg-red-700 { background-color: #b91c1c; }
        .bg-blue-500 { background-color: #22c55e; }
        .bg-cream { background-color: #fefdfb; }
        .text-white { color: white; }
        .text-gray-900 { color: #1a1a1a; }
        .text-gray-600 { color: #525252; }
        .text-sm { font-size: 0.875rem; }
        .relative { position: relative; }
        .absolute { position: absolute; }
        .fixed { position: fixed; }
        .top-4 { top: 1rem; }
        .left-4 { left: 1rem; }
        .right-4 { right: 1rem; }
        .bottom-4 { bottom: 1rem; }
        .bottom-8 { bottom: 2rem; }
        .z-50 { z-index: 50; }
        .left-1\/2 { left: 50%; }
        .z-10 { z-index: 10; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-items: center; }
        .gap-2 { gap: 0.5rem; }
        .gap-4 { gap: 1rem; }
        .gap-1 { gap: 0.25rem; }
        .px-3 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .py-2 { padding-top: 0.5rem; padding-bottom: 0.5rem; }
        .px-4 { padding-left: 1rem; padding-right: 1rem; }
        .py-3 { padding-top: 0.75rem; padding-bottom: 0.75rem; }
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 0.75rem; }
        .p-8 { padding: 2rem; }
        .ml-2 { margin-left: 0.5rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-0\.75 { margin-bottom: 0.1875rem; }
        .mb-0\.5 { margin-bottom: 0.125rem; }
        .rounded-lg { border-radius: 0.5rem; }
        .rounded-xl { border-radius: 0.75rem; }
        .rounded-full { border-radius: 9999px; }
        .cursor-pointer { cursor: pointer; }
        .cursor-grab { cursor: grab; }
        .overflow-hidden { overflow: hidden; }
        .transform { transform: var(--tw-transform); }
        .-translate-x-1\/2 { --tw-translate-x: -50%; transform: translate(var(--tw-translate-x), var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y)); }
        .transition-colors { transition-property: color, background-color, border-color, text-decoration-color, fill, stroke; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .transition-all { transition-property: all; transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); transition-duration: 150ms; }
        .duration-300 { transition-duration: 300ms; }
        .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .shadow-purple-500\/50 { box-shadow: 0 25px 50px -12px rgba(168, 85, 247, 0.5); }
        .hover\:bg-blue-700:hover { background-color: #15803d; }
        .hover\:bg-gray-600:hover { background-color: #525252; }
        .hover\:bg-green-700:hover { background-color: #15803d; }
        .hover\:bg-red-700:hover { background-color: #b91c1c; }
        .hover\:shadow-3xl:hover { box-shadow: 0 35px 60px -12px rgba(0, 0, 0, 0.3); }
        .hover\:scale-105:hover { transform: scale(1.05); }
        .disabled\:bg-gray-800:disabled { background-color: #2d2d2d; }
        .disabled\:opacity-50:disabled { opacity: 0.5; }
        .active\:cursor-grabbing:active { cursor: grabbing; }
        .border { border-width: 1px; }
        .border-gray-600 { border-color: #525252; }
        .focus\:border-blue-500:focus { border-color: #22c55e; }
        .outline-none { outline: 2px solid transparent; outline-offset: 2px; }
        .ring-4 { box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.5); }
        .ring-blue-500 { --tw-ring-color: #22c55e; }
        .ring-purple-500 { --tw-ring-color: #a855f7; }
        .w-2 { width: 0.5rem; }
        .h-2 { height: 0.5rem; }
        .min-h-400 { min-height: 25rem; }
        
        /* Mode button styling */
        .mode-btn {
            transition: all 0.2s ease;
        }
        
        .mode-btn:hover {
            background: #f0f0f0 !important;
        }
        
        .mode-btn.active {
            background: #16a34a !important;
            color: white !important;
        }
        
        /* Network visualization styles */
        #network-canvas svg {
            cursor: grab;
        }
        
        #network-canvas svg:active {
            cursor: grabbing;
        }
        
        /* Custom titlebar removed - using native window frame */
        
        /* View containers use full height with native titlebar */
        .view-container {
            height: 100vh;
            margin-top: 0px;
            top: 0px;
            position: absolute;
            width: 100%;
        }
        
        /* Fix mode button highlighting */
        .mode-btn.active {
            background: #16a34a !important;
            color: white !important;
        }
        
        .mode-btn:not(.active) {
            background: transparent !important;
            color: #666 !important;
        }
        
        /* Add margins to sidebar headers */
        #structure-pane-header {
            padding: 8px 12px !important;
            margin-top: 4px !important;
        }
        
        #structure-pane-title {
            margin-left: 0 !important;
            margin-top: 4px !important;
        }
        
        /* File tree styling improvements */
        #file-tree-view {
            padding: 8px 12px !important;
            margin-top: 4px !important;
        }
        
        /* Remove all bullet points from file tree */
        #file-tree-view ul {
            list-style: none !important;
            padding-left: 0 !important;
            margin: 0 !important;
        }
        
        #file-tree-view li {
            list-style: none !important;
            padding-left: 0 !important;
            margin-left: 0 !important;
        }
        
        /* Proper indentation for nested items */
        #file-tree-view ul.file-tree-children {
            padding-left: 20px !important;
        }
        
        /* Ensure root folder has no indentation */
        #file-tree-view ul.file-tree-root {
            padding-left: 0 !important;
        }

        /* File tree item styling */
        .file-tree-item {
            display: flex;
            align-items: center;
            padding: 2px 4px;
            margin: 1px 0;
            border-radius: 3px;
            cursor: pointer;
            user-select: none;
            font-size: 13px;
            line-height: 1.4;
        }

        .file-tree-item:hover {
            background-color: #f0f0f0;
        }

        body.dark-mode .file-tree-item:hover {
            background-color: #404040;
        }

        .file-tree-item.folder {
            font-weight: 500;
        }

        .file-tree-item.file {
            font-weight: normal;
        }

        .file-tree-item .expand-arrow {
            font-size: 10px;
            transition: transform 0.2s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 12px;
            height: 12px;
        }

        .file-tree-item .file-icon {
            margin-right: 6px;
            font-size: 12px;
        }

        .file-tree-item .file-name {
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* File tree main content */
        .file-tree-main {
            display: flex;
            align-items: center;
        }

        /* File tags display */
        .file-tags {
            margin-top: 2px;
            margin-left: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            font-size: 10px;
            opacity: 0.7;
        }

        .file-tag {
            background: var(--primary-500);
            color: white;
            padding: 1px 4px;
            border-radius: 3px;
            font-size: 9px;
            font-weight: 500;
            display: inline-block;
            max-width: 60px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        body.dark-mode .file-tag {
            background: var(--primary-600);
            color: var(--neutral-100);
        }

        .file-tree-item:hover .file-tags {
            opacity: 1;
        }

        /* Tag search interface */
        #tag-search-input {
            transition: border-color 0.2s;
        }

        #tag-search-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 1px var(--primary-500);
        }

        body.dark-mode #tag-search-input {
            background: var(--neutral-800);
            border-color: var(--neutral-600);
            color: var(--text-color);
        }

        body.dark-mode #tag-search-input:focus {
            border-color: var(--primary-500);
        }

        /* Tag filter chips */
        .tag-chip {
            background: var(--primary-100);
            color: var(--primary-700);
            border: 1px solid var(--primary-300);
            padding: 2px 6px;
            border-radius: 12px;
            font-size: 10px;
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .tag-chip:hover {
            background: var(--primary-200);
        }

        .tag-chip.active {
            background: var(--primary-500);
            color: white;
            border-color: var(--primary-500);
        }

        .tag-chip-remove {
            cursor: pointer;
            font-weight: bold;
            font-size: 12px;
            line-height: 1;
        }

        body.dark-mode .tag-chip {
            background: var(--primary-900);
            color: var(--primary-200);
            border-color: var(--primary-700);
        }

        body.dark-mode .tag-chip:hover {
            background: var(--primary-800);
        }

        body.dark-mode .tag-chip.active {
            background: var(--primary-600);
            color: white;
        }

        /* Status bar styling */
        #editor-status-bar {
            transition: background-color 0.2s, color 0.2s, border-color 0.2s;
        }
        
        /* Dark mode status bar */
        body.dark-mode #editor-status-bar {
            background: #2d2d2d !important;
            border-top-color: #444 !important;
            color: #ccc !important;
        }

        /* Internal link styling (Obsidian-style) */
        .internal-link {
            color: #6366f1 !important;
            text-decoration: none !important;
            background: rgba(99, 102, 241, 0.1) !important;
            padding: 2px 4px !important;
            border-radius: 3px !important;
            border: 1px solid rgba(99, 102, 241, 0.2) !important;
            transition: all 0.2s ease !important;
            cursor: pointer !important;
        }

        .internal-link:hover {
            background: rgba(99, 102, 241, 0.2) !important;
            border-color: rgba(99, 102, 241, 0.4) !important;
            text-decoration: none !important;
        }

        /* Dark mode internal links */
        body.dark-mode .internal-link {
            color: #8b5cf6 !important;
            background: rgba(139, 92, 246, 0.15) !important;
            border-color: rgba(139, 92, 246, 0.3) !important;
        }

        body.dark-mode .internal-link:hover {
            background: rgba(139, 92, 246, 0.25) !important;
            border-color: rgba(139, 92, 246, 0.5) !important;
        }

        /* Find & Replace Dialog */
        #find-replace-dialog {
            position: fixed;
            top: 80px;
            right: 20px;
            z-index: 1000;
            background: #fefdfb;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 16px;
            min-width: 320px;
            font-size: 14px;
        }

        #find-replace-dialog.hidden {
            display: none;
        }

        body.dark-mode #find-replace-dialog {
            background: #2d2d2d;
            border-color: #444;
            color: #e0e0e0;
        }

        .find-replace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            font-weight: 500;
        }

        .find-replace-close {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 18px;
            color: #666;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        body.dark-mode .find-replace-close {
            color: #ccc;
        }

        .find-replace-close:hover {
            color: #333;
        }

        body.dark-mode .find-replace-close:hover {
            color: white;
        }

        .find-replace-field {
            margin-bottom: 8px;
        }

        .find-replace-field label {
            display: block;
            margin-bottom: 4px;
            font-size: 12px;
            color: #666;
        }

        body.dark-mode .find-replace-field label {
            color: #ccc;
        }

        .find-replace-input {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
        }

        body.dark-mode .find-replace-input {
            background: #333;
            border-color: #555;
            color: #e0e0e0;
        }

        .find-replace-input:focus {
            outline: none;
            border-color: #16a34a;
        }

        .find-replace-options {
            display: flex;
            gap: 12px;
            margin: 12px 0;
            font-size: 12px;
        }

        .find-replace-option {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .find-replace-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .find-replace-btn {
            padding: 4px 8px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            color: #333;
        }

        .find-replace-btn:hover {
            background: #e9ecef;
        }

        .find-replace-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        body.dark-mode .find-replace-btn {
            background: #404040;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark-mode .find-replace-btn:hover:not(:disabled) {
            background: #4a4a4a;
        }

        .find-replace-primary {
            background: #16a34a;
            color: white;
            border-color: #16a34a;
        }

        .find-replace-primary:hover:not(:disabled) {
            background: #005a9e;
        }

        .find-replace-stats {
            font-size: 11px;
            color: #666;
            margin-top: 8px;
        }

        body.dark-mode .find-replace-stats {
            color: #aaa;
        }

        /* Monaco Editor Search Highlights */
        .monaco-editor .findMatch {
            background-color: rgba(234, 92, 0, 0.33);
        }

        .monaco-editor .currentFindMatch {
            background-color: rgba(234, 92, 0, 0.66);
        }

        /* Folder Name Dialog */
        #folder-name-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #folder-name-modal.hidden {
            display: none;
        }

        .folder-name-dialog {
            background: #fefdfb;
            border-radius: 8px;
            padding: 24px;
            min-width: 300px;
            max-width: 500px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .folder-name-dialog {
            background: #2d2d2d;
            color: #e0e0e0;
        }

        .folder-name-header {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 16px;
            color: #333;
        }

        body.dark-mode .folder-name-header {
            color: #e0e0e0;
        }

        .folder-name-field {
            margin-bottom: 20px;
        }

        .folder-name-field label {
            display: block;
            margin-bottom: 6px;
            font-size: 14px;
            color: #555;
        }

        body.dark-mode .folder-name-field label {
            color: #ccc;
        }

        .folder-name-input {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            box-sizing: border-box;
        }

        body.dark-mode .folder-name-input {
            background: #333;
            border-color: #555;
            color: #e0e0e0;
        }

        .folder-name-input:focus {
            outline: none;
            border-color: #16a34a;
        }

        .folder-name-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .folder-name-btn {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: #f8f9fa;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            color: #333;
        }

        .folder-name-btn:hover {
            background: #e9ecef;
        }

        body.dark-mode .folder-name-btn {
            background: #404040;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark-mode .folder-name-btn:hover {
            background: #4a4a4a;
        }

        .folder-name-btn.primary {
            background: #16a34a;
            color: white;
            border-color: #16a34a;
        }

        .folder-name-btn.primary:hover {
            background: #005a9e;
        }

        .folder-name-error {
            color: #dc3545;
            font-size: 12px;
            margin-top: 4px;
            display: none;
        }

        /* Command Palette Styles (VS Code style Cmd+P) */
        .command-palette-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 10000;
            display: flex;
            align-items: flex-start;
            justify-content: center;
            padding-top: 120px;
        }

        .command-palette {
            background: var(--neutral-0);
            border: 1px solid var(--neutral-300);
            border-radius: 6px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            width: 600px;
            max-width: 90vw;
            max-height: 60vh;
            display: flex;
            flex-direction: column;
            animation: commandPaletteSlideIn 0.15s ease-out;
        }

        @keyframes commandPaletteSlideIn {
            from {
                opacity: 0;
                transform: translateY(-10px) scale(0.98);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .command-palette-header {
            padding: 12px 16px;
            border-bottom: 1px solid var(--neutral-200);
        }

        #command-palette-input {
            width: 100%;
            border: none;
            outline: none;
            font-size: 16px;
            background: transparent;
            color: var(--text-color);
        }

        #command-palette-input::placeholder {
            color: var(--neutral-500);
        }

        .command-palette-results {
            flex: 1;
            overflow-y: auto;
            max-height: 400px;
        }

        .command-palette-loading {
            padding: 20px;
            text-align: center;
            color: var(--neutral-500);
            font-size: 14px;
        }

        .command-palette-item {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 1px solid var(--neutral-100);
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 14px;
        }

        .command-palette-item:hover,
        .command-palette-item.selected {
            background: var(--primary-100);
        }

        .command-palette-item-icon {
            font-size: 16px;
            width: 20px;
            text-align: center;
            color: var(--neutral-600);
        }

        .command-palette-item-name {
            flex: 1;
            color: var(--text-color);
        }

        .command-palette-item-path {
            font-size: 12px;
            color: var(--neutral-500);
            max-width: 200px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .command-palette-no-results {
            padding: 20px;
            text-align: center;
            color: var(--neutral-500);
            font-size: 14px;
        }

        /* Dark mode styles */
        body.dark-mode .command-palette-overlay {
            background: rgba(0, 0, 0, 0.6);
        }

        body.dark-mode .command-palette {
            background: var(--neutral-800);
            border-color: var(--neutral-600);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .command-palette-header {
            border-bottom-color: var(--neutral-600);
        }

        body.dark-mode .command-palette-item {
            border-bottom-color: var(--neutral-700);
        }

        body.dark-mode .command-palette-item:hover,
        body.dark-mode .command-palette-item.selected {
            background: var(--primary-800);
        }

        /* Structure Action Buttons */
        .structure-actions {
            display: flex;
            gap: 2px;
            opacity: 0;
            transition: opacity 0.2s ease;
            margin-left: auto;
        }

        .structure-heading-text {
            flex: 1;
        }

        li:hover .structure-actions {
            opacity: 1;
        }

        .structure-btn {
            background: transparent;
            border: 1px solid var(--neutral-300);
            border-radius: 3px;
            padding: 2px 6px;
            font-size: 12px;
            line-height: 1;
            cursor: pointer;
            color: var(--neutral-600);
            transition: all 0.2s ease;
            min-width: 20px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: Arial, sans-serif; /* Ensure good arrow display */
            font-weight: bold;
        }

        .structure-btn:hover {
            background: var(--primary-100);
            border-color: var(--primary-300);
            color: var(--primary-700);
        }

        .structure-btn:active {
            transform: scale(0.95);
        }

        /* Button-specific colors */
        .structure-promote:hover {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1976d2;
        }

        .structure-demote:hover {
            background: #fff3e0;
            border-color: #ff9800;
            color: #f57c00;
        }

        .structure-move-up:hover {
            background: #e8f5e8;
            border-color: #4caf50;
            color: #388e3c;
        }

        .structure-move-down:hover {
            background: #fce4ec;
            border-color: #e91e63;
            color: #c2185b;
        }

        /* Dark mode styles for structure buttons */
        body.dark-mode .structure-btn {
            border-color: var(--neutral-600);
            color: var(--neutral-400);
        }

        body.dark-mode .structure-btn:hover {
            background: var(--primary-900);
            border-color: var(--primary-600);
            color: var(--primary-300);
        }

        body.dark-mode .structure-promote:hover {
            background: #0d47a1;
            border-color: #1976d2;
            color: #64b5f6;
        }

        body.dark-mode .structure-demote:hover {
            background: #e65100;
            border-color: #f57c00;
            color: #ffb74d;
        }

        body.dark-mode .structure-move-up:hover {
            background: #1b5e20;
            border-color: #388e3c;
            color: #81c784;
        }

        body.dark-mode .structure-move-down:hover {
            background: #880e4f;
            border-color: #c2185b;
            color: #f48fb1;
        }

        /* Ensure structure list items have proper flex layout */
        #structure-list li {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background-color 0.2s ease;
        }

        #structure-list li:hover {
            background-color: var(--neutral-50);
        }

        #structure-list li.selected {
            background-color: var(--primary-100);
            border-left: 3px solid var(--primary-500);
        }

        body.dark-mode #structure-list li:hover {
            background-color: var(--neutral-800);
        }

        body.dark-mode #structure-list li.selected {
            background-color: var(--primary-900);
            border-left: 3px solid var(--primary-400);
        }

        /* Command Autocomplete Styles */
        .command-autocomplete {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-primary, #1a1a1a);
            border: 1px solid var(--border-color, #333);
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            font-family: 'SF Mono', Monaco, 'Cascadia Code', 'Roboto Mono', monospace;
        }

        .command-option {
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid var(--border-color, #333);
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 13px;
        }

        .command-option:last-child {
            border-bottom: none;
        }

        .command-option:hover,
        .command-option.selected {
            background: var(--selection-bg, #2d3748);
        }

        .command-name {
            color: var(--primary-400, #22c55e);
            font-weight: 600;
        }

        .command-description {
            color: var(--text-secondary, #888);
            font-size: 11px;
            flex: 1;
            margin-left: 12px;
            text-overflow: ellipsis;
            overflow: hidden;
            white-space: nowrap;
        }

        /* Dark mode adjustments */
        body.dark-mode .command-autocomplete {
            background: #1a1a1a;
            border-color: #333;
        }

        body.dark-mode .command-option {
            border-bottom-color: #333;
        }

        body.dark-mode .command-option:hover,
        body.dark-mode .command-option.selected {
            background: #2d3748;
        }

        /* Citation Modal Styles */
        .citation-modal .modal-body {
            max-height: 60vh;
            overflow-y: auto;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .form-group {
            flex: 1;
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 4px;
            font-size: 12px;
            color: #333;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 13px;
            font-family: inherit;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007acc;
            box-shadow: 0 0 0 2px rgba(0, 122, 204, 0.2);
        }

        .form-group small {
            display: block;
            margin-top: 4px;
            font-size: 11px;
            color: #666;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 60px;
        }

        .import-option {
            padding: 16px;
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-bottom: 12px;
        }

        .import-option h4 {
            margin: 0 0 8px 0;
            color: #007acc;
            font-size: 14px;
        }

        .import-option p {
            margin: 0 0 12px 0;
            font-size: 12px;
            color: #666;
        }

        /* Dark mode for citation forms */
        body.dark-mode .form-group label {
            color: #e0e0e0;
        }

        body.dark-mode .form-group input,
        body.dark-mode .form-group select,
        body.dark-mode .form-group textarea {
            background: #333;
            border-color: #555;
            color: #e0e0e0;
        }

        body.dark-mode .form-group input:focus,
        body.dark-mode .form-group select:focus,
        body.dark-mode .form-group textarea:focus {
            border-color: #22c55e;
            box-shadow: 0 0 0 2px rgba(34, 197, 94, 0.2);
        }

        body.dark-mode .import-option {
            background: #2a2a2a;
            border-color: #444;
        }

        body.dark-mode .import-option h4 {
            color: #22c55e;
        }

        /* Citation Buttons - Default compact layout */
        .citation-btn-container {
            display: flex;
            gap: 3px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .citation-btn {
            padding: 3px 6px;
            font-size: 12px;
            min-width: 28px;
            white-space: nowrap;
            transition: all 0.3s ease;
        }
        
        .citation-btn .btn-label {
            display: none;
            margin-left: 4px;
        }
        
        /* Show labels only when sidebar is wide enough */
        .citations-panel.sidebar-wide .citation-btn {
            padding: 4px 8px;
            min-width: auto;
        }
        
        .citations-panel.sidebar-wide .citation-btn .btn-label {
            display: inline;
        }
        
        .citation-separator {
            border-left: 1px solid #ddd;
            height: 18px;
            margin: 0 3px;
        }

        /* Enhanced Citation Modal Styling */
        .citation-modal .modal-body {
            padding: 24px;
            max-height: calc(85vh - 120px);
            overflow-y: auto;
        }

        .citation-modal .form-row {
            gap: 16px;
            margin-bottom: 20px;
        }

        .citation-modal .form-group {
            margin-bottom: 18px;
        }

        .citation-modal .form-group label {
            font-size: 13px;
            margin-bottom: 6px;
        }

        .citation-modal .form-group input,
        .citation-modal .form-group select,
        .citation-modal .form-group textarea {
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        /* Section organization */
        .form-section {
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid #f0f0f0;
        }

        .form-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .form-section h4 {
            margin: 0 0 16px 0;
            font-size: 15px;
            color: #555;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
    </style>
</head>
<body>
    <!-- Command Palette Modal (VS Code style Cmd+P) -->
    <div id="command-palette-overlay" class="command-palette-overlay" style="display: none;">
        <div id="command-palette" class="command-palette">
            <div class="command-palette-header">
                <input type="text" id="command-palette-input" placeholder="Type to search files..." autocomplete="off">
            </div>
            <div id="command-palette-results" class="command-palette-results">
                <div class="command-palette-loading">Loading files...</div>
            </div>
        </div>
    </div>

    <!-- Custom Title Bar -->
    <!-- Custom titlebar removed - using native window controls -->
    
    <!-- Citation Modal Dialogs -->
    <div id="citation-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-dialog citation-modal" style="width: 700px; max-height: 85vh;">
            <div class="modal-header">
                <h3 id="citation-modal-title">Add Citation</h3>
                <button class="modal-close" onclick="citationManager.hideModal('citation-modal-overlay')">×</button>
            </div>
            <div class="modal-body">
                <form id="citation-form">
                    <!-- Citation Type Selection -->
                    <div class="form-section">
                        <div class="form-group">
                            <label for="citation-type">Citation Type *</label>
                            <select id="citation-type" required>
                                <option value="article">Journal Article</option>
                                <option value="book">Book</option>
                                <option value="webpage">Web Page</option>
                                <option value="report">Report</option>
                                <option value="thesis">Thesis/Dissertation</option>
                                <option value="conference">Conference Paper</option>
                                <option value="chapter">Book Chapter</option>
                            </select>
                        </div>
                    </div>

                    <!-- Basic Information -->
                    <div class="form-section">
                        <h4>Basic Information</h4>
                        <div class="form-group">
                            <label for="citation-title">Title *</label>
                            <input type="text" id="citation-title" name="title" required placeholder="Enter the title">
                        </div>

                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="citation-authors">Authors</label>
                                <input type="text" id="citation-authors" name="authors" placeholder="Smith, J., & Doe, A.">
                            </div>
                            <div class="form-group">
                                <label for="citation-year">Year</label>
                                <input type="number" id="citation-year" name="year" min="1000" max="2100" placeholder="2024">
                            </div>
                        </div>
                    </div>

                    <!-- Publication Information -->
                    <div class="form-section">
                        <h4>Publication Details</h4>
                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="citation-journal">Journal/Publisher</label>
                                <input type="text" id="citation-journal" name="journal" placeholder="Journal name or publisher">
                            </div>
                            <div class="form-group">
                                <label for="citation-volume">Volume</label>
                                <input type="text" id="citation-volume" name="volume" placeholder="Vol">
                            </div>
                            <div class="form-group">
                                <label for="citation-issue">Issue</label>
                                <input type="text" id="citation-issue" name="issue" placeholder="No">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label for="citation-pages">Pages</label>
                                <input type="text" id="citation-pages" name="pages" placeholder="1-10">
                            </div>
                            <div class="form-group" style="flex: 2;">
                                <label for="citation-doi">DOI</label>
                                <input type="text" id="citation-doi" name="doi" placeholder="10.1000/example">
                            </div>
                        </div>
                    </div>

                    <!-- Links and Files -->
                    <div class="form-section">
                        <h4>Links & Files</h4>
                        <div class="form-group">
                            <label for="citation-url">URL</label>
                            <input type="url" id="citation-url" name="url" placeholder="https://example.com">
                        </div>

                        <div class="form-group">
                            <label for="citation-file-path">Local File Path</label>
                            <div style="display: flex; gap: 8px;">
                                <input type="text" id="citation-file-path" name="file_path" placeholder="Path to local file" style="flex: 1;">
                                <button type="button" onclick="citationManager.selectFile()" class="btn">Browse</button>
                            </div>
                        </div>
                    </div>

                    <!-- Notes and Organization -->
                    <div class="form-section">
                        <h4>Notes & Organization</h4>
                        <div class="form-group">
                            <label for="citation-abstract">Abstract</label>
                            <textarea id="citation-abstract" name="abstract" rows="3" placeholder="Enter abstract (optional)"></textarea>
                        </div>

                        <div class="form-group">
                            <label for="citation-notes">Personal Notes</label>
                            <textarea id="citation-notes" name="notes" rows="3" placeholder="Your notes about this citation"></textarea>
                        </div>

                        <div class="form-row">
                            <div class="form-group" style="flex: 2;">
                                <label for="citation-tags">Tags</label>
                                <input type="text" id="citation-tags" name="tags" placeholder="philosophy, AI, technology (comma-separated)">
                            </div>
                            <div class="form-group">
                                <label for="citation-projects">Projects</label>
                                <select id="citation-projects" multiple size="3">
                                    <!-- Projects will be populated dynamically -->
                                </select>
                                <small style="color: #666;">Hold Ctrl/Cmd to select multiple projects</small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="citationManager.hideModal('citation-modal-overlay')" class="btn">Cancel</button>
                <button type="button" onclick="citationManager.saveCitation()" class="btn btn-primary" id="save-citation-btn">Save Citation</button>
            </div>
        </div>
    </div>

    <!-- Import Citation Modal -->
    <div id="import-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-dialog" style="width: 500px;">
            <div class="modal-header">
                <h3>Import Citation</h3>
                <button class="modal-close" onclick="citationManager.hideModal('import-modal-overlay')">×</button>
            </div>
            <div class="modal-body">
                <div class="import-options">
                    <div class="import-option">
                        <h4>From URL</h4>
                        <p>Automatically extract citation data from a web page</p>
                        <div style="display: flex; gap: 8px;">
                            <input type="url" id="import-url" placeholder="https://example.com/article" style="flex: 1;">
                            <button onclick="citationManager.importFromURL()" class="btn btn-primary">Import</button>
                        </div>
                    </div>

                    <div class="import-option" style="margin-top: 20px;">
                        <h4>From DOI</h4>
                        <p>Import citation using Digital Object Identifier</p>
                        <div style="display: flex; gap: 8px;">
                            <input type="text" id="import-doi" placeholder="10.1000/example" style="flex: 1;">
                            <button onclick="citationManager.importFromDOI()" class="btn btn-primary">Import</button>
                        </div>
                    </div>

                    <div class="import-option" style="margin-top: 20px;">
                        <h4>From Zotero</h4>
                        <p>Sync citations from your Zotero library</p>
                        <button onclick="citationManager.showZoteroConfig()" class="btn btn-primary">Configure Zotero</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Zotero Configuration Modal -->
    <div id="zotero-modal-overlay" class="modal-overlay" style="display: none;">
        <div class="modal-dialog" style="width: 500px;">
            <div class="modal-header">
                <h3>Zotero Configuration</h3>
                <button class="modal-close" onclick="citationManager.hideModal('zotero-modal-overlay')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="zotero-api-key">Zotero API Key</label>
                    <input type="password" id="zotero-api-key" placeholder="Your Zotero API key">
                    <small style="color: #666;">Get your API key from <a href="https://www.zotero.org/settings/keys" target="_blank">Zotero Settings</a></small>
                </div>

                <div class="form-group">
                    <label for="zotero-user-id">User ID</label>
                    <input type="text" id="zotero-user-id" placeholder="Your Zotero user ID">
                </div>

                <div class="form-group">
                    <label for="zotero-collection">Collection (optional)</label>
                    <div style="display: flex; gap: 8px; align-items: center;">
                        <input type="text" id="zotero-collection" placeholder="Collection ID or leave empty for entire library" style="flex: 1;">
                        <button type="button" id="browse-collections-btn" class="btn" style="white-space: nowrap;">Browse Collections</button>
                    </div>
                    <div id="selected-collection-info" style="margin-top: 8px; padding: 8px; background-color: #f0f9ff; border: 1px solid #bae6fd; border-radius: 4px; display: none;">
                        <div style="font-weight: bold; color: #0369a1;" id="selected-collection-name"></div>
                        <div style="font-size: 12px; color: #0369a1;" id="selected-collection-items"></div>
                    </div>
                    <small style="color: #666;">Leave empty to sync entire library, or click "Browse Collections" to choose</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="citationManager.hideModal('zotero-modal-overlay')" class="btn">Cancel</button>
                <button type="button" onclick="citationManager.syncWithZotero()" class="btn btn-primary">Sync Now</button>
            </div>
        </div>
    </div>

    <!-- Export Citations Modal -->
    <div id="export-modal" class="modal" style="display: none;">
        <div class="modal-dialog" style="width: 500px;">
            <div class="modal-header">
                <h3 class="modal-title">Export Citations</h3>
                <button type="button" class="modal-close" onclick="citationManager.hideModal('export-modal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Export Format</label>
                    <select id="export-format" class="form-control">
                        <option value="bibtex">BibTeX (.bib)</option>
                        <option value="ris">RIS (.ris)</option>
                        <option value="csv">CSV (.csv)</option>
                        <option value="json">JSON (.json)</option>
                        <option value="apa">APA Format (.txt)</option>
                        <option value="mla">MLA Format (.txt)</option>
                        <option value="chicago">Chicago Format (.txt)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Export Selection</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="radio" name="export-selection" value="all" checked> Export All Citations
                        </label>
                        <label class="checkbox-label">
                            <input type="radio" name="export-selection" value="filtered"> Export Current Filter Results
                        </label>
                        <label class="checkbox-label">
                            <input type="radio" name="export-selection" value="selected"> Export Selected Citations Only
                        </label>
                    </div>
                    <small style="color: #666; margin-top: 4px; display: block;">
                        Note: "Selected citations" feature coming soon. Currently exports all or filtered citations.
                    </small>
                </div>
                
                <div class="form-group">
                    <label>Export Destination</label>
                    <div class="checkbox-group">
                        <label class="checkbox-label">
                            <input type="radio" name="export-destination" value="download" checked> Download to Browser
                        </label>
                        <label class="checkbox-label">
                            <input type="radio" name="export-destination" value="project"> Save to Project Directory
                        </label>
                    </div>
                    <small style="color: #666; margin-top: 4px; display: block;">
                        Project directory saves will be placed in your current working directory.
                    </small>
                </div>

                <div id="export-preview" class="form-group" style="display: none;">
                    <label>Preview (first 3 citations)</label>
                    <textarea id="export-preview-content" readonly style="height: 150px; font-family: monospace; font-size: 11px;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="preview-export-btn" class="btn" onclick="citationManager.previewExport()">Preview</button>
                <button type="button" id="cancel-export-btn" class="btn" onclick="citationManager.hideModal('export-modal')">Cancel</button>
                <button type="button" id="download-export-btn" class="btn btn-primary" onclick="citationManager.downloadExport()">Download</button>
            </div>
        </div>
    </div>
    
    <!-- Main Application Container -->
    <div id="app-container">
        <!-- Left Sidebar (Always visible) -->
        <div id="left-sidebar">
            <div id="structure-pane-header">
                <div class="toggle-buttons structure-toggle-buttons" style="display: flex; gap: 2px; overflow: hidden;">
                    <button id="show-files-btn" class="btn pane-toggle-button" title="Show File Tree" style="padding: 4px 6px; font-size: 14px; min-width: 32px;">📁</button>
                    <button id="show-structure-btn" class="btn pane-toggle-button active" title="Show Document Structure" style="padding: 4px 6px; font-size: 14px; min-width: 32px;">🏗️</button>
                    <button id="show-search-btn" class="btn pane-toggle-button" title="Global Search" style="padding: 4px 6px; font-size: 14px; min-width: 32px;">🔍</button>
                    <button id="show-stats-btn" class="btn pane-toggle-button" title="Presentation Statistics" style="padding: 4px 6px; font-size: 14px; min-width: 32px;">📊</button>
                    <button id="show-citations-btn" class="btn pane-toggle-button" title="Citation Manager" style="padding: 4px 6px; font-size: 14px; min-width: 32px;">📚</button>
                </div>
                <!-- Tag search interface (only visible in Files view) -->
                <div id="tag-search-section" style="display: none; margin-top: 4px;">
                    <input type="text" id="tag-search-input" placeholder="Search files by name or tag..." style="width: 100%; padding: 4px 8px; border: 1px solid var(--neutral-300); border-radius: 4px; font-size: 11px; background: var(--neutral-0);">
                    <div id="tag-filter-chips" style="margin-top: 4px; display: flex; flex-wrap: wrap; gap: 4px; min-height: 20px;"></div>
                </div>
                <div style="display: flex; align-items: center; justify-content: space-between; margin-top: 4px;">
                    <h2 id="structure-pane-title">Structure</h2>
                    <div style="display: flex; gap: 4px;">
                        <button id="change-directory-btn" class="btn" title="Change Working Directory" style="display: none; padding: 4px 8px; font-size: 11px;">📁 Directory</button>
                        <button id="new-folder-btn" class="btn" title="Create New Folder" style="padding: 4px 8px; font-size: 11px;">+ Folder</button>
                    </div>
                </div>
            </div>
            <div style="flex: 1; overflow-y: auto;">
                <ul id="structure-list"></ul>
                <div id="file-tree-view" style="display: none;"></div>
                <div id="search-pane" class="content-pane" style="display: none; height: 100%; padding: 12px; flex-direction: column;">
                    <!-- Global Search and Replace Interface -->
                    <div class="search-controls" style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 12px;">
                        <div style="padding: 8px; background: #f0f7ff; border-radius: 4px; margin-bottom: 8px; font-size: 12px; color: #0066cc;">
                            💡 <strong>Tip:</strong> Search will include tags, metadata (title, category, description), and file content. Click on tags in results to filter files.
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="global-search-input" placeholder="Search in all files, tags, and metadata..." style="flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 3px;">
                            <button id="global-search-execute" class="btn" title="Execute Search">Search</button>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <input type="text" id="global-replace-input" placeholder="Replace with..." style="flex: 1; padding: 6px; border: 1px solid #ccc; border-radius: 3px;">
                            <button id="global-replace-execute" class="btn" title="Replace All Matches" style="background: #dc3545; color: white;">Replace All</button>
                            <button id="global-replace-preview" class="btn" title="Preview Replacements">Preview</button>
                        </div>
                        <div class="search-options" style="display: flex; gap: 12px; font-size: 12px;">
                            <label style="display: flex; align-items: center; gap: 4px;">
                                <input type="checkbox" id="search-case-sensitive"> Case Sensitive
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                                <input type="checkbox" id="search-whole-word"> Whole Word
                            </label>
                            <label style="display: flex; align-items: center; gap: 4px;">
                                <input type="checkbox" id="search-regex"> Regex
                            </label>
                        </div>
                        <div class="search-file-types" style="display: flex; gap: 8px; align-items: center; font-size: 12px;">
                            <span>Files:</span>
                            <input type="text" id="search-file-pattern" placeholder="*.md, *.txt" style="flex: 1; padding: 4px; border: 1px solid #ccc; border-radius: 3px; font-size: 11px;">
                        </div>
                    </div>
                    
                    <!-- Search Results -->
                    <div class="search-results-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding: 4px 0; border-bottom: 1px solid #eee;">
                        <span id="search-results-count" style="font-size: 12px; color: #666;">No search performed</span>
                        <button id="clear-search-results" class="btn" style="padding: 2px 6px; font-size: 11px;" title="Clear Results">Clear</button>
                    </div>
                    <div id="search-results" style="flex: 1; overflow-y: auto; font-size: 13px; min-height: 200px;"></div>
                </div>
                <div id="statistics-pane" class="content-pane" style="display: none; height: 100%; padding: 12px; flex-direction: column;">
                    <!-- Statistics Panel -->
                    <div class="statistics-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #007bff;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <h3 style="margin: 0; color: #007bff; font-size: 16px;">📊 Statistics</h3>
                            <div style="display: flex; gap: 4px; background: #f8f9fa; border: 1px solid #ddd; border-radius: 6px; padding: 2px;">
                                <button id="stats-scope-document" class="stats-scope-btn active" style="padding: 4px 8px; border: none; background: #007bff; color: white; border-radius: 4px; cursor: pointer; font-size: 11px;">Document</button>
                                <button id="stats-scope-project" class="stats-scope-btn" style="padding: 4px 8px; border: none; background: transparent; color: #666; border-radius: 4px; cursor: pointer; font-size: 11px;">Project</button>
                            </div>
                        </div>
                        <div style="display: flex; gap: 8px; align-items: center;">
                            <button id="refresh-statistics-btn" class="btn" style="padding: 4px 8px; font-size: 11px;" title="Refresh Statistics">🔄 Refresh</button>
                        </div>
                    </div>
                    <div id="statistics-content" style="flex: 1; overflow-y: auto;">
                        <!-- Statistics will be populated here -->
                        <p style="color: #666; text-align: center; padding: 20px;">
                            Load a presentation to see statistics.
                        </p>
                    </div>
                </div>
                <div id="citations-pane" class="content-pane citations-panel" style="display: none; height: 100%; padding: 12px; flex-direction: column;">
                    <!-- Citations Panel -->
                    <div class="citations-header" style="display: flex; flex-direction: column; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #007bff;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <h3 style="margin: 0; color: #007bff; font-size: 16px;">📚 Citations</h3>
                                <div id="citations-stats" style="font-size: 11px; color: #666; padding: 2px 6px; background: #f8f9fa; border-radius: 4px;">
                                    <!-- Citation count will be shown here -->
                                </div>
                            </div>
                            <div class="citation-btn-container">
                            <!-- Primary Actions -->
                            <button id="add-citation-btn" class="btn citation-btn" style="background: #28a745; color: white;" title="Add New Citation">
                                <span class="btn-icon">➕</span><span class="btn-label">Add</span>
                            </button>
                            <button id="import-citation-btn" class="btn citation-btn" title="Import Citation">
                                <span class="btn-icon">📥</span><span class="btn-label">Import</span>
                            </button>
                            <button id="export-citations-btn" class="btn citation-btn" title="Export Citations">
                                <span class="btn-icon">📤</span><span class="btn-label">Export</span>
                            </button>
                            <div class="citation-separator"></div>
                            <!-- Selection -->
                            <button id="select-all-citations-btn" class="btn citation-btn" title="Select/Deselect All">
                                <span class="btn-icon">☑️</span><span class="btn-label">Select All</span>
                            </button>
                            <button id="delete-selected-citations-btn" class="btn citation-btn" style="background: #dc3545; color: white;" title="Delete Selected Citations">
                                <span class="btn-icon">🗑️</span><span class="btn-label">Delete Selected</span>
                            </button>
                            <!-- Zotero Actions -->
                            <button id="export-to-zotero-btn" class="btn citation-btn" style="background: #dc3545; color: white;" title="Export Selected to Zotero">
                                <span class="btn-icon">📚</span><span class="btn-label">To Zotero</span>
                            </button>
                            <button id="live-sync-zotero-btn" class="btn citation-btn" style="background: #17a2b8; color: white;" title="Live Sync with Zotero">
                                <span class="btn-icon">🔄</span><span class="btn-label">Live Sync</span>
                            </button>
                            <div class="citation-separator"></div>
                            <!-- Utility -->
                            <button id="refresh-citations-btn" class="btn citation-btn" title="Refresh Citations">
                                <span class="btn-icon">🔃</span><span class="btn-label">Refresh</span>
                            </button>
                            </div>
                        </div>
                        <!-- Collection Switcher (below buttons) -->
                        <div id="collection-switcher" style="display: flex; align-items: center; gap: 8px; justify-content: flex-end;">
                            <select id="quick-collection-selector" style="font-size: 11px; padding: 4px 6px; border: 1px solid #ddd; border-radius: 3px; background: white; min-width: 120px; display: none;">
                                <option value="">Entire Library</option>
                            </select>
                            <button id="refresh-collections-btn" class="btn" style="font-size: 11px; padding: 4px 6px; border: 1px solid #ddd; background: white; display: none;" title="Refresh Collections">
                                🔄
                            </button>
                        </div>
                    </div>
                    
                    <!-- Search and Filter -->
                    <div class="citations-search" style="margin-bottom: 12px;">
                        <input type="text" id="citations-search-input" placeholder="Search citations by title, author, tags, DOI..." 
                               style="width: 100%; padding: 6px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                        
                        <!-- Filter and Sort Row -->
                        <div style="display: flex; gap: 6px; margin-top: 6px; flex-wrap: wrap; align-items: center;">
                            <!-- Filter Controls -->
                            <select id="citations-type-filter" style="padding: 2px 4px; font-size: 11px; border: 1px solid #ddd; border-radius: 3px;">
                                <option value="">All Types</option>
                                <option value="article">Articles</option>
                                <option value="book">Books</option>
                                <option value="webpage">Web Pages</option>
                                <option value="report">Reports</option>
                                <option value="thesis">Thesis</option>
                                <option value="conference">Conference</option>
                                <option value="chapter">Chapters</option>
                            </select>
                            <select id="citations-project-filter" style="padding: 2px 4px; font-size: 11px; border: 1px solid #ddd; border-radius: 3px;">
                                <option value="">All Projects</option>
                                <!-- Projects will be populated here -->
                            </select>
                            <select id="citations-year-filter" style="padding: 2px 4px; font-size: 11px; border: 1px solid #ddd; border-radius: 3px;">
                                <option value="">All Years</option>
                                <!-- Years will be populated dynamically -->
                            </select>
                            
                            <!-- Advanced SQL Toggle -->
                            <button id="citations-advanced-toggle" title="Toggle Advanced SQL Query" style="padding: 2px 6px; font-size: 11px; border: 1px solid #ddd; border-radius: 3px; background: #f5f5f5; cursor: pointer;">
                                SQL
                            </button>
                            
                            <!-- Separator -->
                            <div style="border-left: 1px solid #ddd; height: 16px; margin: 0 4px;"></div>
                            
                            <!-- Sort Controls -->
                            <select id="citations-sort-by" style="padding: 2px 4px; font-size: 11px; border: 1px solid #ddd; border-radius: 3px;">
                                <option value="created_at_desc">Recently Added</option>
                                <option value="title_asc">Title A-Z</option>
                                <option value="title_desc">Title Z-A</option>
                                <option value="authors_asc">Author A-Z</option>
                                <option value="authors_desc">Author Z-A</option>
                                <option value="year_desc">Year (Newest)</option>
                                <option value="year_asc">Year (Oldest)</option>
                                <option value="citation_type_asc">Type A-Z</option>
                            </select>
                            
                            <button id="clear-citation-filters" class="btn" style="padding: 2px 6px; font-size: 10px;" title="Clear All Filters">✕</button>
                        </div>
                    </div>
                    
                    <!-- Advanced SQL Query Panel (hidden by default) -->
                    <div id="citations-sql-panel" style="display: none; margin: 6px 0; padding: 8px; border: 1px solid #ddd; border-radius: 4px; background: #f9f9f9;">
                        <div style="margin-bottom: 4px; font-size: 11px; color: #666; display: flex; justify-content: space-between; align-items: center;">
                            <span>🔍 Advanced SQL Query (SELECT only)</span>
                            <button id="citations-sql-examples" style="padding: 1px 4px; font-size: 10px; border: 1px solid #ccc; background: #fff; border-radius: 2px; cursor: pointer;">Examples</button>
                        </div>
                        <div style="display: flex; gap: 4px;">
                            <textarea id="citations-sql-input" placeholder="SELECT * FROM citations WHERE title LIKE '%search%'" 
                                      style="flex: 1; padding: 4px; border: 1px solid #ddd; border-radius: 3px; font-family: monospace; font-size: 11px; min-height: 40px; resize: vertical;"></textarea>
                            <button id="citations-sql-execute" style="padding: 4px 8px; font-size: 11px; border: 1px solid #007acc; background: #007acc; color: white; border-radius: 3px; cursor: pointer; white-space: nowrap;">Execute</button>
                        </div>
                    </div>
                    
                    <!-- Citations List -->
                    <div id="citations-content" style="flex: 1; overflow-y: auto;">
                        <div id="citations-loading" style="text-align: center; padding: 20px; color: #666; display: none;">
                            Loading citations...
                        </div>
                        <div id="citations-empty" style="text-align: center; padding: 20px; color: #666;">
                            <div style="font-size: 24px; margin-bottom: 8px;">📚</div>
                            <div>No citations yet</div>
                            <div style="font-size: 11px; margin-top: 4px;">Click "Add" to create your first citation</div>
                        </div>
                        <div id="citations-list" style="display: none;">
                            <!-- Citations will be populated here -->
                        </div>
                    </div>
                </div>
                <!-- TEMP DEBUG: Test button -->
            </div>
        </div>

        <!-- Resizer for left sidebar -->
        <div id="sidebar-resizer" class="resizer" style="width: 4px; cursor: ew-resize; background: #ddd;"></div>

        <!-- Main Content Area (Switches between editor and presentation) -->
        <div id="main-content">
            <!-- Content Mode Switcher -->
            <div id="mode-switcher" style="height: 40px; border-bottom: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; background: #f8f9fa; padding: 0 16px;">
                <!-- Navigation Controls -->
                <div id="navigation-controls" style="display: flex; align-items: center; gap: 4px;">
                    <button id="nav-back-btn" class="nav-btn" title="Go Back (Alt+Left)" disabled style="padding: 6px 10px; border: 1px solid #ccc; background: #fefdfb; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                        ← Back
                    </button>
                    <button id="nav-forward-btn" class="nav-btn" title="Go Forward (Alt+Right)" disabled style="padding: 6px 10px; border: 1px solid #ccc; background: #fefdfb; border-radius: 4px; cursor: pointer; font-size: 12px; display: flex; align-items: center; gap: 4px;">
                        Forward →
                    </button>
                    <div style="width: 1px; height: 20px; background: #ccc; margin: 0 8px;"></div>
                    <span id="current-file-name" style="font-size: 11px; color: #666; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        No file selected
                    </span>
                </div>
                
                <!-- Mode Switcher -->
                <div style="display: flex; gap: 4px; padding: 4px; background: #fefdfb; border: 1px solid #ddd; border-radius: 6px;">
                    <button id="editor-mode-btn" class="mode-btn active" style="padding: 6px 16px; border: none; background: #16a34a; color: white; border-radius: 4px; cursor: pointer; font-size: 12px;">Editor</button>
                    <button id="presentation-mode-btn" class="mode-btn" style="padding: 6px 16px; border: none; background: transparent; color: #666; border-radius: 4px; cursor: pointer; font-size: 12px;">Presentation</button>
                    <button id="network-mode-btn" class="mode-btn" style="padding: 6px 16px; border: none; background: transparent; color: #666; border-radius: 4px; cursor: pointer; font-size: 12px;">Network</button>
                    <button id="circle-mode-btn" class="mode-btn" style="padding: 6px 16px; border: none; background: transparent; color: #666; border-radius: 4px; cursor: pointer; font-size: 12px;">Circle</button>
                </div>
                
                <!-- Pane Toggle Controls -->
                <div style="display: flex; gap: 4px; align-items: center;">
                    <span style="font-size: 11px; color: #666; margin-right: 4px;">Panes:</span>
                    <button id="toggle-sidebar-btn" class="btn" title="Toggle Files/Structure Pane" style="padding: 4px 8px; font-size: 11px; background: #16a34a; color: white; border-radius: 3px;">📁</button>
                    <button id="toggle-editor-btn" class="btn" title="Toggle Editor Pane" style="padding: 4px 8px; font-size: 11px; background: #16a34a; color: white; border-radius: 3px;">📝</button>
                    <button id="toggle-preview-btn" class="btn" title="Toggle Preview Pane" style="padding: 4px 8px; font-size: 11px; background: #16a34a; color: white; border-radius: 3px;">👁</button>
                    <button id="toggle-gamification-btn" class="btn" title="Toggle Writing Stats Panel" style="padding: 4px 8px; font-size: 11px; background: #f59e0b; color: white; border-radius: 3px;">🎮</button>
                </div>
            </div>

            <!-- Editor Content -->
            <div id="editor-content" class="content-view active">
                <!-- Editor Toolbar (spans both editor and preview panes) -->
                <div id="editor-toolbar">
                        <!-- Markdown Formatting Tools -->
                        <button id="format-bold-btn" class="toolbar-btn toolbar-btn-bold" title="Bold (Ctrl+B)">
                            B
                        </button>
                        <button id="format-italic-btn" class="toolbar-btn toolbar-btn-italic" title="Italic (Ctrl+I)">
                            I
                        </button>
                        <button id="format-code-btn" class="toolbar-btn toolbar-btn-code" title="Inline Code (Ctrl+`)">
                            &lt;&gt;
                        </button>
                        <div class="toolbar-separator"></div>
                        <button id="format-h1-btn" class="toolbar-btn toolbar-btn-bold" title="Heading 1">
                            H1
                        </button>
                        <button id="format-h2-btn" class="toolbar-btn toolbar-btn-bold" title="Heading 2">
                            H2
                        </button>
                        <button id="format-h3-btn" class="toolbar-btn toolbar-btn-bold" title="Heading 3">
                            H3
                        </button>
                        <div class="toolbar-separator"></div>
                        <button id="format-list-btn" class="toolbar-btn" title="Bulleted List">
                            •
                        </button>
                        <button id="format-numbered-list-btn" class="toolbar-btn" title="Numbered List">
                            1.
                        </button>
                        <button id="format-quote-btn" class="toolbar-btn" title="Blockquote">
                            &gt;
                        </button>
                        <div class="toolbar-separator"></div>
                        <button id="format-inline-math-btn" class="toolbar-btn toolbar-btn-code" title="Inline Math ($...$)">
                            $x$
                        </button>
                        <button id="format-display-math-btn" class="toolbar-btn toolbar-btn-code" title="Display Math ($$...$$)">
                            $$
                        </button>
                        <div class="toolbar-separator"></div>
                        <button id="format-link-btn" class="toolbar-btn" title="Insert Link (Ctrl+K)">
                            🔗
                        </button>
                        <button id="format-image-btn" class="toolbar-btn" title="Insert Image">
                            🖼️
                        </button>
                        <button id="format-table-btn" class="toolbar-btn" title="Insert Table">
                            📊
                        </button>
                        <div class="toolbar-separator"></div>
                        <button id="auto-slide-markers-btn" class="toolbar-btn" title="Add Slide Markers to Paragraphs">
                            📄→
                        </button>
                        <button id="remove-slide-markers-btn" class="toolbar-btn" title="Remove All Slide Markers">
                            📄✖️
                        </button>
                        <button id="insert-speaker-notes-btn" class="toolbar-btn" title="Insert Speaker Notes Template">
                            📝
                        </button>
                        <button id="insert-toc-btn" class="toolbar-btn" title="Insert Table of Contents">
                            📑+
                        </button>
                        <button id="remove-toc-btn" class="toolbar-btn" title="Remove Table of Contents">
                            📑✖️
                        </button>
                        
                        <div class="toolbar-separator"></div>
                        
                        <button id="command-palette-btn" class="toolbar-btn" title="Command Palette (Cmd+Shift+P)">
                            🎯
                        </button>
                        
                        <!-- Annotation Controls -->
                        <div class="toolbar-separator"></div>
                        <button id="insert-comment-annotation-btn" class="toolbar-btn" title="Insert Comment Annotation">
                            💬
                        </button>
                        <button id="insert-highlight-annotation-btn" class="toolbar-btn" title="Insert Highlight Annotation">
                            🟡
                        </button>
                        <button id="insert-block-annotation-btn" class="toolbar-btn" title="Insert Block Annotation">
                            📋
                        </button>
                        
                        <div class="toolbar-separator"></div>
                        <span style="font-size: 11px; color: #666;">Format</span>
                        <div class="toolbar-separator"></div>
                        <button id="fold-all-btn" class="toolbar-btn" title="Fold All Sections (Ctrl+K, Ctrl+0)">
                            📁
                        </button>
                        <button id="unfold-all-btn" class="toolbar-btn" title="Unfold All Sections (Ctrl+K, Ctrl+J)">
                            📂
                        </button>
                        <button id="fold-current-btn" class="toolbar-btn" title="Fold Current Section (Ctrl+Shift+[)">
                            ⬇️
                        </button>
                        <button id="unfold-current-btn" class="toolbar-btn" title="Unfold Current Section (Ctrl+Shift+])">
                            ⬆️
                        </button>
                        <div class="toolbar-separator"></div>
                        <button id="global-search-btn" class="toolbar-btn" title="Global Search (Ctrl+Shift+F)">
                            🔍
                        </button>
                        <button id="ai-todo-suggestions-btn" class="toolbar-btn" title="Get AI TODO Suggestions">
                            🤖
                        </button>
                        <button id="invoke-ash-btn" class="toolbar-btn" title="Invoke Ash (AI Writing Companion) - Cmd+Shift+'">
                            💬
                        </button>
                </div>
                <!-- Container for editor and preview panes -->
                <div id="panes-container" style="display: flex; flex: 1; overflow: hidden;">
                    <div id="editor-pane">
                        <div id="editor-container" style="width: 100%; flex: 1;"></div>
                        <textarea id="fallback-editor" style="display: none; width: 100%; flex: 1; box-sizing: border-box; border: 1px solid #ccc; font-family: monospace; padding: 5px;"></textarea>
                        <!-- Status Bar -->
                        <div id="editor-status-bar" style="height: 24px; background: #f8f9fa; border-top: 1px solid #ddd; display: flex; align-items: center; justify-content: space-between; padding: 0 12px; font-size: 12px; color: #666; flex-shrink: 0;">
                            <div id="status-left" style="display: flex; align-items: center; gap: 12px;">
                                <span id="word-count">Words: 0</span>
                                <span id="char-count">Characters: 0</span>
                                <span id="line-count">Lines: 1</span>
                            </div>
                            <div id="status-right" style="display: flex; align-items: center; gap: 12px;">
                                <span id="cursor-position">Ln 1, Col 1</span>
                                <span id="file-status">Markdown (.md)</span>
                            </div>
                        </div>
                    </div>
                    <div id="resizer" class="resizer" style="width: 4px; cursor: ew-resize; background: #ddd;"></div>
                    <div id="right-pane">
                    <div style="flex: 1; display: flex; flex-direction: column; min-height: 0;">
                        <div id="preview-pane" class="content-pane">
                            <div id="preview-content"></div>
                        </div>
                        <div id="chat-pane" class="content-pane terminal-chat" style="display: none;">
                            <div class="terminal-header">
                                <span class="terminal-subtitle" id="chat-context-display">Your AI writing companion • Type /help for commands</span>
                            </div>
                            <div id="chat-messages" class="terminal-output" style="flex: 1; overflow-y: auto; margin-bottom: 16px;"></div>
                            <div class="terminal-input-area" style="display: flex; align-items: center; gap: 8px;">
                                <span class="terminal-prompt-line">
                                    <span class="terminal-user">you</span><span class="terminal-separator">:</span> 
                                </span>
                                <div style="position: relative; flex: 1;">
                                    <input type="text" id="chat-input" class="terminal-input" placeholder="Ask Dr Chen anything about your writing..." style="width: 100%;">
                                    <div id="command-autocomplete" class="command-autocomplete" style="display: none;">
                                        <!-- Autocomplete suggestions will be populated here -->
                                    </div>
                                </div>
                                <div class="terminal-buttons" style="display: flex; gap: 4px;">
                                    <button id="attach-image-btn" class="btn btn-small" title="Attach image" onclick="window.handleAttachImage()">📷</button>
                                    <button id="generate-image-btn" class="btn btn-small" title="Generate image with AI" onclick="window.handleGenerateImage()">🎨</button>
                                    <button id="restart-chat-btn" class="btn btn-small" title="Start new chat session">🔄</button>
                                    <button id="load-editor-to-chat-btn" class="btn btn-small" title="Load current editor content into chat">📝</button>
                                    <button id="copy-ai-response-btn" class="btn btn-small" title="Insert last AI response at cursor position">📋</button>
                                    <button id="save-chat-btn" class="btn btn-small" title="Save chat as markdown file">💾</button>
                                </div>
                                <input type="file" id="image-input" accept="image/*" multiple style="display: none;" onchange="window.handleImageInput(event)">
                                <div id="attached-images-preview" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;"></div>
                            </div>
                        </div>
                        
                        <div id="speaker-notes-pane" class="content-pane" style="display: none; height: 100%; padding: 12px; flex-direction: column;">
                            <!-- Speaker Notes Interface -->
                            <div class="speaker-notes-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 8px; border-bottom: 2px solid #007bff;">
                                <h3 style="margin: 0; color: #007bff; font-size: 16px;">📝 Speaker Notes</h3>
                                <button id="toggle-speaker-notes-in-preview" class="btn" style="padding: 4px 8px; font-size: 11px;" title="Toggle Notes in Preview">Show in Preview</button>
                            </div>
                            
                            <div id="speaker-notes-content" style="flex: 1; overflow-y: auto; font-size: 14px; line-height: 1.6;">
                                <p style="color: #666; text-align: center; padding: 20px;">
                                    No speaker notes found.<br>
                                    <small>Add notes using <code>```notes</code> blocks in your Markdown.</small>
                                </p>
                            </div>
                            
                            <div class="speaker-notes-help" style="margin-top: 12px; padding: 8px; background: #f8f9fa; border-radius: 4px; font-size: 12px; color: #666;">
                                <strong>Tip:</strong> Use <code>```notes</code> in your Markdown to add speaker notes that won't appear on slides.
                            </div>
                        </div>

                        <div id="wholepart-pane" class="content-pane" style="display: none; height: 100%; flex-direction: column;">
                            <!-- Whole/Part Relations Interface -->
                            <div class="wholepart-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding: 8px 12px; border-bottom: 2px solid #4ecdc4;">
                                <h3 style="margin: 0; color: #4ecdc4; font-size: 16px;">🔗 Concept Relations</h3>
                                <div style="display: flex; gap: 8px; align-items: center;">
                                    <select id="wholepart-visualization-type" style="padding: 4px 8px; font-size: 11px; border: 1px solid #ddd; border-radius: 4px;">
                                        <option value="0">Circular Ring</option>
                                        <option value="1">Center-Radial</option>
                                        <option value="2">Containment</option>
                                        <option value="3">Spiral Center</option>
                                        <option value="4">Spiral Parts</option>
                                        <option value="5">Dialectical</option>
                                        <option value="6">Spiral Radial</option>
                                        <option value="7">Fractal</option>
                                        <option value="8">Nested</option>
                                    </select>
                                    <button id="wholepart-refresh" class="btn" style="padding: 4px 8px; font-size: 11px;" title="Refresh Data">🔄</button>
                                </div>
                            </div>
                            
                            <div id="wholepart-description" style="padding: 8px 12px; background: #f8f9fa; border-radius: 4px; margin: 0 12px 12px 12px; font-size: 12px; color: #555;">
                                <strong>Visualization:</strong> <span id="wholepart-description-text">Select a visualization to explore concept relationships.</span>
                            </div>

                            <!-- Viewing Options -->
                            <div id="wholepart-viewing-options" style="margin: 0 12px 12px 12px; padding: 8px 12px; background: #fff; border: 1px solid #e0e0e0; border-radius: 4px; font-size: 11px;">
                                <div style="margin-bottom: 8px; font-weight: bold; color: #4ecdc4;">Viewing Options:</div>
                                
                                <!-- Checkboxes -->
                                <div style="display: flex; flex-wrap: wrap; gap: 12px; margin-bottom: 10px;">
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="wholepart-show-labels" style="margin-right: 4px;" checked>
                                        <span>Show Labels</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="wholepart-show-connections" style="margin-right: 4px;" checked>
                                        <span>Show Connections</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="wholepart-animate-transitions" style="margin-right: 4px;" checked>
                                        <span>Animate Transitions</span>
                                    </label>
                                    <label style="display: flex; align-items: center; cursor: pointer;">
                                        <input type="checkbox" id="wholepart-dark-theme" style="margin-right: 4px;">
                                        <span>Dark Theme</span>
                                    </label>
                                </div>

                                <!-- Size Slider -->
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                                    <label for="wholepart-size-slider" style="min-width: 60px;">Node Size:</label>
                                    <input type="range" id="wholepart-size-slider" min="0.1" max="3" step="0.1" value="1" style="flex: 1; min-width: 100px;">
                                    <span id="wholepart-size-value" style="min-width: 30px; text-align: center; color: #666;">1.0x</span>
                                </div>
                                
                                <!-- Opacity Slider -->
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <label for="wholepart-opacity-slider" style="min-width: 60px;">Opacity:</label>
                                    <input type="range" id="wholepart-opacity-slider" min="0.1" max="1" step="0.1" value="1" style="flex: 1; min-width: 100px;">
                                    <span id="wholepart-opacity-value" style="min-width: 30px; text-align: center; color: #666;">100%</span>
                                </div>
                                
                                <!-- Spiral Tightness Slider (only visible for spiral views) -->
                                <div id="wholepart-spiral-controls" style="display: none; align-items: center; gap: 8px;">
                                    <label for="wholepart-spiral-slider" style="min-width: 60px;">Spiral:</label>
                                    <input type="range" id="wholepart-spiral-slider" min="0.5" max="4" step="0.1" value="2" style="flex: 1; min-width: 100px;">
                                    <span id="wholepart-spiral-value" style="min-width: 30px; text-align: center; color: #666;">2.0x</span>
                                </div>
                            </div>
                            
                            <div id="wholepart-visualization" style="flex: 1; overflow: hidden; margin: 0 12px; border: 1px solid #e0e0e0; border-radius: 4px; background: #fefdfb;">
                                <!-- D3 visualization will be rendered here -->
                            </div>
                            
                            <div class="wholepart-controls" style="display: flex; justify-content: center; gap: 6px; padding: 8px 8px; border-top: 1px solid #e0e0e0; flex-wrap: wrap;">
                                <button id="wholepart-animate" class="btn" style="padding: 4px 8px; font-size: 11px;">▶️ Animate</button>
                                <button id="wholepart-reset" class="btn" style="padding: 4px 8px; font-size: 11px;">🔄 Reset</button>
                                <button id="wholepart-export-png" class="btn" style="padding: 4px 8px; font-size: 11px; background: #4CAF50; color: white; border: 1px solid #45a049;">📸 Export</button>
                                <button id="wholepart-zoom-in" class="btn" style="padding: 4px 6px; font-size: 11px;">+</button>
                                <button id="wholepart-zoom-out" class="btn" style="padding: 4px 6px; font-size: 11px;">-</button>
                            </div>
                        </div>
                    </div>
                    <div class="toggle-buttons" style="padding: 4px 8px; border-top: 1px solid #ddd; display: flex !important; flex-direction: row !important; flex-wrap: nowrap !important; min-height: 32px; max-height: 40px;">
                        <button id="show-preview-btn" class="btn pane-toggle-button active" style="padding: 6px 8px; font-size: 12px;">Preview</button>
                        <button id="show-chat-btn" class="btn pane-toggle-button" style="padding: 6px 8px; font-size: 12px;">AI Chat</button>
                        <button id="show-speaker-notes-btn" class="btn pane-toggle-button" style="padding: 6px 8px; font-size: 12px;">📝 Notes</button>
                        <button id="show-wholepart-btn" class="btn pane-toggle-button" style="padding: 6px 8px; font-size: 12px;">🔗 Relations</button>
                    </div>
                </div>
                </div> <!-- End panes-container -->
            </div>

            <!-- Presentation Content -->
            <div id="presentation-content" class="content-view" style="display: flex; flex-direction: column; position: relative;">
                <div id="presentation-export-controls" style="position: absolute; top: 10px; right: 10px; z-index: 1000;"></div>
                <div id="presentation-root" style="width: 100%; flex: 1; min-height: 0;"></div>
                <div id="speaker-notes-panel" style="display: none !important;">
                    <!-- Resize Handle -->
                    <div id="speaker-notes-resize-handle" style="position: absolute; top: 0; left: 0; right: 0; height: 8px; background: #34495e; cursor: ns-resize; border-radius: 4px 4px 0 0; display: flex; align-items: center; justify-content: center;">
                        <div style="width: 40px; height: 3px; background: #7f8c8d; border-radius: 2px;"></div>
                    </div>
                    <!-- Header -->
                    <div style="margin: 16px 16px 8px 16px; padding-top: 8px;">
                        <h4 style="margin: 0; font-size: 14px; color: #ecf0f1;">📝 Speaker Notes</h4>
                    </div>
                    <!-- Scrollable Content -->
                    <div id="current-slide-notes" style="font-size: 13px; line-height: 1.4; color: #bdc3c7; padding: 0 16px 16px 16px; overflow-y: auto; height: calc(100% - 60px);">
                        <em>No speaker notes for this slide.</em>
                    </div>
                </div>
            </div>
            
            <!-- Network Visualization Content -->
            <div id="network-content" class="content-view" style="display: flex; flex-direction: column; position: relative;">
                <div id="network-visualization" style="width: 100%; flex: 1; min-height: 0;">
                    <!-- Unified network visualization will be rendered here -->
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #666;">
                        <div style="font-size: 24px; margin-bottom: 10px;">🔗</div>
                        <div>Loading network visualization...</div>
                    </div>
                </div>
            </div>
            
            <!-- Circle Visualization Content -->
            <div id="circle-content" class="content-view" style="display: flex; flex-direction: column; position: relative;">
                <div id="circle-export-controls" style="position: absolute; top: 10px; right: 10px; z-index: 1000;"></div>
                <div id="circle-visualization" style="width: 100%; flex: 1; min-height: 0; background: #fafafa;">
                    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: #666;">
                        <div style="font-size: 24px; margin-bottom: 10px;">🔄</div>
                        <div>Hermeneutic Circle</div>
                        <div style="font-size: 12px; margin-top: 5px; color: #999;">Exploring iterative understanding patterns</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Find & Replace Dialog -->
    <div id="find-replace-dialog" class="hidden">
        <div class="find-replace-header">
            <span>Find & Replace</span>
            <button class="find-replace-close" id="find-replace-close">&times;</button>
        </div>
        
        <div class="find-replace-field">
            <label for="find-input">Find:</label>
            <input type="text" id="find-input" class="find-replace-input" placeholder="Enter search text">
        </div>
        
        <div class="find-replace-field">
            <label for="replace-input">Replace:</label>
            <input type="text" id="replace-input" class="find-replace-input" placeholder="Enter replacement text">
        </div>
        
        <div class="find-replace-options">
            <label class="find-replace-option">
                <input type="checkbox" id="case-sensitive"> Case sensitive
            </label>
            <label class="find-replace-option">
                <input type="checkbox" id="regex-mode"> Regex
            </label>
            <label class="find-replace-option">
                <input type="checkbox" id="whole-word"> Whole word
            </label>
        </div>
        
        <div class="find-replace-actions">
            <button class="find-replace-btn find-replace-primary" id="find-next">Find Next</button>
            <button class="find-replace-btn" id="find-previous">Find Previous</button>
            <button class="find-replace-btn" id="replace-current">Replace</button>
            <button class="find-replace-btn" id="replace-all">Replace All</button>
        </div>
        
        <div class="find-replace-stats" id="find-replace-stats">
            <!-- Stats will be populated by JavaScript -->
        </div>
    </div>

    <!-- Folder Name Modal -->
    <div id="folder-name-modal" class="hidden">
        <div class="folder-name-dialog">
            <div class="folder-name-header">Create New Folder</div>
            
            <div class="folder-name-field">
                <label for="folder-name-input">Folder name:</label>
                <input type="text" id="folder-name-input" class="folder-name-input" placeholder="Enter folder name">
                <div class="folder-name-error" id="folder-name-error"></div>
            </div>
            
            <div class="folder-name-actions">
                <button class="folder-name-btn" id="folder-name-cancel">Cancel</button>
                <button class="folder-name-btn primary" id="folder-name-create">Create</button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script>
    // Monaco editor configuration for Electron - disable web workers to avoid file:// issues
    window.MonacoEnvironment = {
        getWorker: function (workerId, label) {
            return undefined; // Disable web workers, use main thread
        }
    };
    
    // Check if Monaco editor resources are available before loading renderer
    if (typeof require !== 'undefined') {
        // Load Monaco editor configuration
        require.config({ 
            paths: { 'vs': './node_modules/monaco-editor/min/vs' },
            'vs/nls': { availableLanguages: { '*': 'en' } }
        });
    }
    </script>
    <script src="./node_modules/monaco-editor/min/vs/loader.js" defer></script>
    
    <!-- Load modules first -->
    <script src="orchestrator/modules/internalLinks.js" defer></script>
    <script src="orchestrator/modules/annotations.js" defer></script>
    <script src="orchestrator/modules/formatting.js" defer></script>
    <script src="orchestrator/modules/aiChat.js" defer></script>
    <script src="orchestrator/modules/export.js" defer></script>
    <script src="orchestrator/modules/search.js" defer></script>
    <script src="orchestrator/modules/findReplace.js" defer></script>
    <script src="orchestrator/modules/navigation.js" defer></script>
    <script src="orchestrator/modules/commandPalette.js" defer></script>
    <script src="orchestrator/modules/kanban.js" defer></script>
    <script src="orchestrator/modules/settings.js" defer></script>
    <script src="orchestrator/modules/listManagement.js" defer></script>
    <script src="orchestrator/modules/speakerNotes.js" defer></script>
    <script src="orchestrator/modules/autosave.js" defer></script>
    <!-- D3.js v7.8.5 already loaded above with React/Babel -->
    <script src="orchestrator/modules/wholepart.js" defer></script>
    <!-- AI Assistant Configuration -->
    <script src="orchestrator/modules/ai-assistant-config.js" defer></script>
    <!-- AI Writing Companion - Modular Architecture -->
    <script src="orchestrator/modules/ai-companion/analysis/TextAnalysisEngine.js" defer></script>
    <script src="orchestrator/modules/ai-companion/context/ContextManager.js" defer></script>
    <script src="orchestrator/modules/ai-companion/feedback/FeedbackSystem.js" defer></script>
    <script src="orchestrator/modules/ai-companion/AICompanionManager.js" defer></script>
    <!-- Gamification System - Modular Architecture -->
    <script src="orchestrator/modules/gamification/core/WritingSession.js" defer></script>
    <script src="orchestrator/modules/gamification/timers/FocusTimer.js" defer></script>
    <script src="orchestrator/modules/gamification/core/FlowState.js" defer></script>
    <script src="orchestrator/modules/gamification/data/DataPersistence.js" defer></script>
    <script src="orchestrator/modules/gamification/GamificationManager.js" defer></script>
    <script src="orchestrator/modules/gamification.js" defer></script>
    <script src="orchestrator/modules/collaborative-challenges.js" defer></script>
    <script src="orchestrator/modules/challenges-ui.js" defer></script>
    <!-- AI Flow Detection - Modular System -->
    <script src="orchestrator/modules/ai-flow-detection/TextCollectionManager.js" defer></script>
    <script src="orchestrator/modules/ai-flow-detection/TypingPatternAnalyzer.js" defer></script>
    <script src="orchestrator/modules/ai-flow-detection/CognitiveLoadAssessment.js" defer></script>
    <script src="orchestrator/modules/ai-flow-detection/FlowStateEngine.js" defer></script>
    <script src="orchestrator/modules/ai-flow-detection/InsightsEngine.js" defer></script>
    <script src="orchestrator/modules/ai-flow-detection/FlowIndicatorUI.js" defer></script>
    <script src="orchestrator/modules/ai-flow-detection/AIFlowDetectionManager.js" defer></script>
    <script src="orchestrator/modules/ai-flow-detection/index.js" defer></script>
    <script src="orchestrator/modules/todo-gamification.js" defer></script>
    <script src="orchestrator/modules/dragdrop.js" defer></script>
    <script src="orchestrator/modules/previewZoom.js" defer></script>
    <script src="orchestrator/modules/fileFilters.js" defer></script>
    <script src="orchestrator/modules/tagManager.js" defer></script>
    <script src="orchestrator/modules/scholar-support.js" defer></script>
    <script type="module" src="orchestrator/modules/graph.js" defer></script>
    <script type="module" src="orchestrator/modules/circle.js" defer></script>
    
    <!-- Style management modules -->
    <script src="styles/style-manager.js" defer></script>
    
    <script src="styles/style-settings-ui.js" defer></script>
    
    <!-- Export visualization module -->
    <script src="orchestrator/modules/exportVisualization.js" defer></script>
    
    <!-- Main renderer script -->
    <script src="orchestrator/renderer.js" defer></script>
    
    <!-- Load compiled React components -->
    <script src="components/dist/MarkdownPreziApp.js" defer></script>
    
    <!-- Load JavaScript modules -->
    <script src="services/ttsService.js" defer></script>
    <script src="services/videoRecordingService.js" defer></script>
    <script src="orchestrator/modules/citationManager.js" defer></script>
    <script src="js/speaker-notes.js" defer></script>
    <script src="js/mode-switcher.js" defer></script>  
    <script src="js/network-visualization.js" defer></script>
    <script src="orchestrator/modules/unifiedNetwork.js" defer></script>
    <script src="js/editor-utils.js" defer></script>
    <script src="js/app-init.js" defer></script>

    <!-- Zotero Collections Browser Modal -->
    <div id="collections-browser-modal-overlay" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px; max-height: 70vh;">
            <div class="modal-header">
                <h3>Browse Zotero Collections</h3>
                <span class="close" onclick="citationManager.hideModal('collections-browser-modal-overlay')">&times;</span>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <div id="collections-loading" style="text-align: center; padding: 20px;">
                    <div class="loading-spinner"></div>
                    <p>Loading collections...</p>
                </div>
                <div id="collections-list" style="display: none;">
                    <div style="margin-bottom: 10px;">
                        <button type="button" id="select-entire-library-btn" class="btn" style="width: 100%; text-align: left; padding: 10px;">
                            📚 <strong>Entire Library</strong>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">Sync all items in your library</div>
                        </button>
                    </div>
                    <div id="collections-container"></div>
                </div>
                <div id="collections-error" style="display: none; color: #dc3545; padding: 20px; text-align: center;">
                    <p>Failed to load collections. Please check your credentials and try again.</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" onclick="citationManager.hideModal('collections-browser-modal-overlay')" class="btn">Cancel</button>
            </div>
        </div>
    </div>
</body>
</html>